<!DOCTYPE html>
<html>
<head>
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { background: #0088cc; color: white; border: none; padding: 10px; border-radius: 5px; margin: 5px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { padding: 10px; text-align: center; border: 1px solid #ddd; cursor: pointer; }
        .day:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>üìö –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h1>
    <button id="record-btn">üìù –ó–∞–ø–∏—Å–∞—Ç—å –î–ó</button>
    <button id="view-btn">üîç –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –î–ó</button>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å (–ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–æ–∫) -->
    <div id="calendar" style="display: none;">
        <h2 id="calendar-title"></h2>
        <div class="calendar" id="calendar-days"></div>
    </div>

    <!-- –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã) -->
    <div id="subject-select" style="display: none;">
        <h2 id="subject-title"></h2>
        <div id="subject-buttons"></div>
    </div>

    <!-- –í–≤–æ–¥ –î–ó (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–∞) -->
    <div id="hw-input" style="display: none;">
        <h2 id="hw-title"></h2>
        <textarea id="hw-text" rows="5" style="width: 100%;"></textarea>
        <button id="hw-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –î–ó (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã) -->
    <div id="hw-view" style="display: none;">
        <h2 id="view-title"></h2>
        <ul id="hw-list"></ul>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const recordBtn = document.getElementById("record-btn");
        const viewBtn = document.getElementById("view-btn");
        const calendarDiv = document.getElementById("calendar");
        const subjectSelectDiv = document.getElementById("subject-select");
        const hwInputDiv = document.getElementById("hw-input");
        const hwViewDiv = document.getElementById("hw-view");

        let currentMode = ""; // "record" –∏–ª–∏ "view"
        let selectedDate = null;
        let selectedSubject = "";

        // –ó–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É
        async function fetchAPI(endpoint, method = "GET", body = null) {
            const response = await fetch(`http://–≤–∞—à-–±—ç–∫–µ–Ω–¥:8000${endpoint}`, {
                method,
                headers: { "Content-Type": "application/json" },
                body: body ? JSON.stringify(body) : null
            });
            return await response.json();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        function showCalendar(mode) {
            currentMode = mode;
            calendarDiv.style.display = "block";
            subjectSelectDiv.style.display = "none";
            hwInputDiv.style.display = "none";
            hwViewDiv.style.display = "none";

            const today = new Date();
            renderCalendar(today.getFullYear(), today.getMonth());
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function renderCalendar(year, month) {
            const calendarDays = document.getElementById("calendar-days");
            calendarDays.innerHTML = "";

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            document.getElementById("calendar-title").textContent = 
                `${firstDay.toLocaleString('default', { month: 'long' })} ${year}`;

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement("div");
                dayElement.className = "day";
                dayElement.textContent = day;
                dayElement.onclick = () => selectDate(new Date(year, month, day));
                calendarDays.appendChild(dayElement);
            }
        }

        // –í—ã–±–æ—Ä –¥–∞—Ç—ã
        async function selectDate(date) {
            selectedDate = date;
            const dayNum = date.getDay(); // 0-6 (–≤—Å-—Å–±)

            if (currentMode === "record") {
                if (dayNum >= 1 && dayNum <= 5) { // –ü–Ω-–ü—Ç
                    const subjects = await fetchAPI(`/subjects/${dayNum}`);
                    showSubjectSelection(dayNum, date, subjects.subjects);
                } else {
                    alert("–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å!");
                }
            } else {
                const homeworks = await fetchAPI(`/get_homework/${date.toISOString().split('T')[0]}`);
                showHomeworkList(date, homeworks.homeworks);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞
        function showSubjectSelection(dayNum, date, subjects) {
            calendarDiv.style.display = "none";
            subjectSelectDiv.style.display = "block";

            document.getElementById("subject-title").textContent = 
                `–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (${date.toLocaleDateString()})`;

            const subjectButtons = document.getElementById("subject-buttons");
            subjectButtons.innerHTML = "";

            subjects.forEach(subject => {
                const btn = document.createElement("button");
                btn.textContent = subject;
                btn.onclick = () => selectSubject(subject, date);
                subjectButtons.appendChild(btn);
            });
        }

        // –í—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞
        function selectSubject(subject, date) {
            selectedSubject = subject;
            subjectSelectDiv.style.display = "none";
            hwInputDiv.style.display = "block";

            document.getElementById("hw-title").textContent = 
                `–î–ó –ø–æ ${subject} –Ω–∞ ${date.toLocaleDateString()}`;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –î–ó
        document.getElementById("hw-save").onclick = async function() {
            const hwText = document.getElementById("hw-text").value;
            await fetchAPI("/save_homework", "POST", {
                subject: selectedSubject,
                date: selectedDate.toISOString().split('T')[0],
                text: hwText
            });
            alert("–î–ó —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            hwInputDiv.style.display = "none";
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –î–ó
        function showHomeworkList(date, homeworks) {
            calendarDiv.style.display = "none";
            hwViewDiv.style.display = "block";

            document.getElementById("view-title").textContent = 
                `–î–ó –Ω–∞ ${date.toLocaleDateString()}`;

            const hwList = document.getElementById("hw-list");
            hwList.innerHTML = "";

            if (homeworks.length === 0) {
                hwList.innerHTML = "<li>–ù–µ—Ç –î–ó –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</li>";
            } else {
                homeworks.forEach(hw => {
                    const li = document.createElement("li");
                    li.textContent = hw;
                    hwList.appendChild(li);
                });
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        recordBtn.onclick = () => showCalendar("record");
        viewBtn.onclick = () => showCalendar("view");
    </script>
</body>
</html>